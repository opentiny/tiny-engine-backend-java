<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tinyengine.it.mapper.BlocksMapper">

    <!-- 通用设置 -->

    <!-- 通用查询列 -->
    <sql id="Base_Column_List">
        id
        , label, framework, content, created_at, updated_at, assets, createdBy, updatedBy, last_build_info, description, tags, current_history, screenshot, `path`, occupier, isOfficial, `public`, isDefault, tiny_reserved, author, name_cn, npm_name, created_app, content_blocks
    </sql>

    <!-- 通用条件列 -->
    <sql id="BlocksByCondition">
        <if test="label!=null and label!=''">
            AND label = #{label}
        </if>
        <if test="framework!=null and framework!=''">
            AND framework = #{framework}
        </if>
        <if test="content!=null and content!=''">
            AND content = #{content}
        </if>
        <if test="createdAt!=null and createdAt!=''">
            AND created_at = #{createdAt}
        </if>
        <if test="updatedAt!=null and updatedAt!=''">
            AND updated_at = #{updatedAt}
        </if>
        <if test="assets!=null and assets!=''">
            AND assets = #{assets}
        </if>
        <if test="createdBy!=null and createdBy!=''">
            AND createdBy = #{createdBy}
        </if>
        <if test="updatedBy!=null and updatedBy!=''">
            AND updatedBy = #{updatedBy}
        </if>
        <if test="lastBuildInfo!=null and lastBuildInfo!=''">
            AND last_build_info = #{lastBuildInfo}
        </if>
        <if test="description!=null and description!=''">
            AND description = #{description}
        </if>
        <if test="tags!=null and tags!=''">
            AND tags = #{tags}
        </if>
        <if test="currentHistory!=null and currentHistory!=''">
            AND current_history = #{currentHistory}
        </if>
        <if test="screenshot!=null and screenshot!=''">
            AND screenshot = #{screenshot}
        </if>
        <if test="path!=null and path!=''">
            AND `path` = #{path}
        </if>
        <if test="occupier!=null and occupier!=''">
            AND occupier = #{occupier}
        </if>
        <if test="isOfficial!=null and isOfficial!=''">
            AND isOfficial = #{isOfficial}
        </if>
        <if test="isPublic!=null and isPublic!=''">
            AND `public` = #{isPublic}
        </if>
        <if test="isDefault!=null and isDefault!=''">
            AND isDefault = #{isDefault}
        </if>
        <if test="tinyReserved!=null and tinyReserved!=''">
            AND tiny_reserved = #{tinyReserved}
        </if>
        <if test="author!=null and author!=''">
            AND author = #{author}
        </if>
        <if test="nameCn!=null and nameCn!=''">
            AND name_cn = #{nameCn}
        </if>
        <if test="npmName!=null and npmName!=''">
            AND npm_name = #{npmName}
        </if>
        <if test="createdApp!=null and createdApp!=''">
            AND created_app = #{createdApp}
        </if>
        <if test="contentBlocks!=null and contentBlocks!=''">
            AND content_blocks = #{contentBlocks}
        </if>
    </sql>

    <!-- 通用设置列 -->
    <sql id="BlocksSetColumns">
        <if test="label!=null and label!=''">
            label = #{label},
        </if>
        <if test="framework!=null and framework!=''">
            framework = #{framework},
        </if>
        <if test="content!=null and content!=''">
            content = #{content},
        </if>
        <if test="createdAt!=null and createdAt!=''">
            created_at = #{createdAt},
        </if>
        <if test="updatedAt!=null and updatedAt!=''">
            updated_at = #{updatedAt},
        </if>
        <if test="assets!=null and assets!=''">
            assets = #{assets},
        </if>
        <if test="createdBy!=null and createdBy!=''">
            createdBy = #{createdBy},
        </if>
        <if test="updatedBy!=null and updatedBy!=''">
            updatedBy = #{updatedBy},
        </if>
        <if test="lastBuildInfo!=null and lastBuildInfo!=''">
            last_build_info = #{lastBuildInfo},
        </if>
        <if test="description!=null and description!=''">
            description = #{description},
        </if>
        <if test="tags!=null and tags!=''">
            tags = #{tags},
        </if>
        <if test="currentHistory!=null and currentHistory!=''">
            current_history = #{currentHistory},
        </if>
        <if test="screenshot!=null and screenshot!=''">
            screenshot = #{screenshot},
        </if>
        <if test="path!=null and path!=''">
            `path` = #{path},
        </if>
        <if test="occupier!=null and occupier!=''">
            occupier = #{occupier},
        </if>
        <if test="isOfficial!=null and isOfficial!=''">
            isOfficial = #{isOfficial},
        </if>
        <if test="isPublic!=null and isPublic!=''">
            `public` = #{isPublic},
        </if>
        <if test="isDefault!=null and isDefault!=''">
            isDefault = #{isDefault},
        </if>
        <if test="tinyReserved!=null and tinyReserved!=''">
            tiny_reserved = #{tinyReserved},
        </if>
        <if test="author!=null and author!=''">
            author = #{author},
        </if>
        <if test="nameCn!=null and nameCn!=''">
            name_cn = #{nameCn},
        </if>
        <if test="npmName!=null and npmName!=''">
            npm_name = #{npmName},
        </if>
        <if test="createdApp!=null and createdApp!=''">
            created_app = #{createdApp},
        </if>
        <if test="contentBlocks!=null and contentBlocks!=''">
            content_blocks = #{contentBlocks},
        </if>
    </sql>


    <!-- 通用查询映射结果 -->
    <resultMap id="BlocksMap" type="com.tinyengine.it.model.entity.Blocks">
        <id column="id" property="id"/>
        <result column="label" property="label"/>
        <result column="framework" property="framework"/>
        <result column="content" property="content"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="assets" property="assets"/>
        <result column="createdBy" property="createdBy"/>
        <result column="updatedBy" property="updatedBy"/>
        <result column="last_build_info" property="lastBuildInfo"/>
        <result column="description" property="description"/>
        <result column="tags" property="tags" jdbcType="VARCHAR" typeHandler="com.tinyengine.it.utils.ListTypeHandler"/>
        <result column="current_history" property="currentHistory"/>
        <result column="screenshot" property="screenshot"/>
        <result column="path" property="path"/>
        <result column="occupier" property="occupier"/>
        <result column="isOfficial" property="isOfficial"/>
        <result column="public" property="isPublic"/>
        <result column="isDefault" property="isDefault"/>
        <result column="tiny_reserved" property="tinyReserved"/>
        <result column="author" property="author"/>
        <result column="name_cn" property="nameCn"/>
        <result column="npm_name" property="npmName"/>
        <result column="created_app" property="createdApp"/>
        <result column="content_blocks" property="contentBlocks"/>
    </resultMap>

    <!-- 查询表blocks所有数据 -->
    <select id="findAllBlocks" resultMap="BlocksMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM blocks
    </select>


    <!-- 根据区块分组id查询表blocks信息 -->
    <select id="findBlocksByBlockGroup" resultType="java.util.Map">
        SELECT
        <include refid="Base_Column_List"/>
        FROM blocks
        WHERE id in (

        SELECT block_id FROM `blocks_groups__block_groups_blocks` where `block-group_id` = #{id})
    </select>


    <!-- 根据区块分类appId查询表blocks信息 -->
    <select id="findBlocksByBlockCategoriesAppId" resultMap="BlocksMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM blocks
        WHERE id in (
        SELECT block_id FROM `blocks_categories__block_categories_blocks` where `block-category_id` in

        (SELECT id FROM `block_categories` where app = #{appId}))
    </select>

    <!-- 根据区块label查询表blocks信息 -->
    <select id="findBlocksByLabels" resultMap="BlocksMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM blocks
        WHERE label in
        <foreach collection="labelList" item="item" open="(" separator="," close=")">
            ${item}
        </foreach>
    </select>


    <!-- 根据区块分类appId查询表blocks信息 -->
    <select id="findBlocksByBlockCategoriesId" resultMap="BlocksMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM blocks
        WHERE id in (
        SELECT block_id FROM `blocks_categories__block_categories_blocks` where `block-category_id` =
        #{blockCategoryId})
    </select>

    <!-- 根据name_cn或者description模糊查询表blocks信息 -->
    <select id="findBlocksByNameCnAndDes" resultMap="BlocksMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM blocks
        <where>
            <if test="nameCn != null and nameCn != ''">
                name_cn like concat('%',#{nameCn},'%')
            </if>
            <if test="description != null and description != ''">
                or description like concat('%',#{description},'%')
            </if>
        </where>
    </select>

    <!-- 根据主键id查询表blocks信息 -->
    <select id="findBlocksById" resultMap="BlocksMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM blocks
        WHERE id=#{id}
    </select>

    <!-- 根据条件查询表blocks数据 -->
    <select id="findBlocksByCondition" resultMap="BlocksMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM blocks
        WHERE 1=1
        <include refid="BlocksByCondition"/>
    </select>

    <!-- 根据主键id删除表blocks数据 -->
    <delete id="deleteBlocksById">
        DELETE
        FROM blocks
        WHERE id = #{id}
    </delete>

    <!-- 根据主键id更新表blocks数据 -->
    <update id="updateBlocksById" parameterType="com.tinyengine.it.model.entity.Blocks">
        UPDATE blocks
        <set>
            <include refid="BlocksSetColumns"/>
        </set>
        WHERE
        id=#{id}
    </update>

    <!-- 新增表blocks数据 -->
    <insert id="createBlocks" useGeneratedKeys="true" keyProperty="id"
            parameterType="com.tinyengine.it.model.entity.Blocks">
        INSERT INTO blocks ( id
                           , label
                           , framework
                           , content
                           , created_at
                           , updated_at
                           , assets
                           , createdBy
                           , updatedBy
                           , last_build_info
                           , description
                           , tags
                           , current_history
                           , screenshot
                           , path
                           , occupier
                           , isOfficial
                           , public
                           , isDefault
                           , tiny_reserved
                           , author
                           , name_cn
                           , npm_name
                           , created_app
                           , content_blocks)
        VALUES ( #{id}
               , #{label}
               , #{framework}
               , #{content}
               , #{createdAt}
               , #{updatedAt}
               , #{assets}
               , #{createdBy}
               , #{updatedBy}
               , #{lastBuildInfo}
               , #{description}
               , #{tags}
               , #{currentHistory}
               , #{screenshot}
               , #{path}
               , #{occupier}
               , #{isOfficial}
               , #{isPublic}
               , #{isDefault}
               , #{tinyReserved}
               , #{author}
               , #{nameCn}
               , #{npmName}
               , #{createdApp}
               , #{contentBlocks})
    </insert>
</mapper>
